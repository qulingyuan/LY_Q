# 闭包

## 闭包的概念

大多数文章甚至以前的 MDN 对 JavaScript 闭包的定义为：

> 闭包是指那些能够访问自由变量的函数。
>
> 自由变量是指在函数中使用的，但既不是函数参数也不是函数的局部变量的变量。

再来看下权威书籍和现在的 MDN 对 JS 闭包的定义：

> 闭包指的是那些引用了另一个函数作用域中变量的函数，通常是在嵌套函数中实现的。
> --JavaScript高级程序设计（第四版）

> 一个函数和对其周围状态（**lexical environment，词法环境**）的引用捆绑在一起（或者说函数被引用包围），这样的组合就是**闭包**（**closure**）。也就是说，闭包让你可以在一个内层函数中访问到其外层函数的作用域。在 JavaScript 中，每当创建一个函数，闭包就会在函数创建的同时被创建出来。
> --MDN

这里 MDN 的定义是更准确的，也建议使用这个定义来理解 JS 闭包，即**闭包是一个绑定了执行环境的函数**。

对于闭包，我觉得我们可以从广义的理论和狭义的实践两个角度去理解。

1. 从广义的理论上来说，在 JavaScript 中，由于每个函数都存在执行上下文，且执行上下文中都存在**词法环境**，所以可以说 **JavaScript 中的函数就是闭包**。

2. 从狭义的实践上来说，有两种类型的函数叫做闭包：

   1. 引用了**自由变量**的函数是闭包。自由变量是指在函数中没有定义，但在函数中被使用了的变量。

   2. 即使创建它的上下文已经销毁，仍然存在（比如，内部函数从父函数中返回）的函数。

## 闭包的应用

1. ### 隐藏数据/模拟私有变量的实现

```javascript
//闭包隐藏数据，只提供API
function createCache(){
    const data = {}; // 闭包中的数据，被隐藏，不被外界访问
    return {
        set:function(key,val){
            data[key] = val;
        },
        get:function(key){
            return data[key];
        }
    }
}

const c = createCache();
c.set("a",100);
console.log(c.get("a"));
```

2. ### 模拟私有变量的实现

```javascript
// 利用闭包生成IIFE，返回 User 类
const User = (function() {
    // 定义私有变量_password
    let _password

    class User {
        constructor (username, password) {
            // 初始化私有变量_password
            _password = password
            this.username = username
        }

       login() {
           // 这里我们增加一行 console，为了验证 login 里仍可以顺利拿到密码
           console.log(this.username, _password)
           // 使用 fetch 进行登录请求，同上，此处省略
       }
    }

    return User
})()

let user = new User('ly', 'pageNotFound')

console.log(user.username)
console.log(user.password)
console.log(user._password)
user.login()
```



3. ### 	偏函数和柯里化

柯里化：是把接受多个参数的函数变换成接受 一个单一参数(最初函数的第一个参数)的函数，并且返回接受余下的参数而且返回结果的新函数的技术。

偏函数：固定你函数的某一个或几个参数，然后返回一个新的函数(这 个函数用于接收剩下的参数)。

柯里化封装函数：

```javascript
//args.length是实参长度，func.length是形参长度
//函数柯里化
function curry(func) {
  return function curried(...args) {
    if (args.length >= func.length) {
      return func.apply(this, args);
    } else {
      return function (...args2) {
        return curried.apply(this, args.concat(args2));
      };
    }
  };
}

function sum(a, b, c) {
  return a + b + c;
}

const currysum = curry(sum);

console.log(currysum(1)(2)(3)); //6
console.log(currysum(1)(2, 3)); //6
console.log(currysum(1, 2, 3)); //6
```

